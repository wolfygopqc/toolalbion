<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tool Albion | Trading Inter-Cités (Europe)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="items.js"></script> <!-- Ajout du fichier items.js -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

    <script>
        const renderHeader = (activePage) => {
            const pages = [
                { name: 'Market', icon: 'trending-up', file: 'index.html', label: 'Marché', active: activePage === 'Market' },
                { name: 'Gold', icon: 'coins', file: 'gold_prices.html', label: 'Or', active: activePage === 'Gold' },
                { name: 'Breeding', icon: 'egg', file: 'breeding.html', label: 'Élevage', active: activePage === 'Breeding' },
                { name: 'Timers', icon: 'clock', file: 'timers.html', label: 'Timers', active: activePage === 'Timers' },
                { name: 'Map', icon: 'map', file: 'map.html', label: 'Carte', active: activePage === 'Map' },

            ];

            // Rendu du Header (Conserve le max-width pour l'en-tête pour la lisibilité)
            return `
                <div class="header-section">
                    <div class="max-w-full 2xl:max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                        <div class="flex items-center justify-between h-16">
                            <div class="flex-shrink-0 text-2xl font-bold text-blue-400">
                                Tools Albion <span class="text-gray-400 text-sm font-normal ml-2"></span>
                            </div>
                            
                            <div class="flex space-x-2 sm:space-x-4">
                                ${pages.map(page => `
                                    <a href="${page.file}" 
                                        class="px-3 py-2 rounded-lg text-sm font-medium transition duration-150 ease-in-out flex items-center
                                        ${page.active 
                                            ? 'bg-blue-600 text-white shadow-lg shadow-blue-500/50' 
                                            : 'text-gray-300 hover:bg-gray-700 hover:text-white'}"
                                    >
                                        <i data-lucide="${page.icon}" class="w-4 h-4 mr-1 sm:mr-2"></i>
                                        <span class="hidden sm:inline">${page.label}</span>
                                    </a>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        };
    </script>
    <style>
        /* Configuration de la police Inter */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #12121e; /* Fond très sombre */
            color: #e4e4e7; /* Texte clair */
        }
        /* Style pour une barre de défilement propre */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-thumb { background-color: #3b82f6; border-radius: 4px; }
        ::-webkit-scrollbar-track { background-color: #1a1a2e; }

        /* Style pour la barre de navigation (VOTRE CSS) */
        .header-section {
            background-color: #1a1a2e;
            padding: 1rem 0;
            border-bottom: 1px solid #3f3f46;
            position: sticky;
            top: 0;
            z-index: 50;
        }

        /* Styles supplémentaires pour la bascule moderne (modern-toggle-switch) */
        .modern-toggle-switch {
            position: relative;
            display: inline-block;
            width: 48px;
            height: 28px;
        }

        .modern-toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .modern-toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #3f3f46; /* Gris foncé */
            transition: .4s;
            border-radius: 28px;
        }

        .modern-toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .modern-toggle-slider {
            background-color: #3b82f6; /* Bleu */
        }

        input:checked + .modern-toggle-slider:before {
            transform: translateX(20px);
        }
    </style>
</head>
<body class="min-h-screen">
    
    <div id="header-placeholder"></div>

    <script>
        // La fonction renderHeader est maintenant dans le <head> et est connue.
        document.getElementById('header-placeholder').innerHTML = renderHeader('Market'); 
        
        // Ceci active les icônes Lucide.
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }
    </script>
    
    <script>

// Fonction pour calculer la différence de temps et la formater
const getTimeAgo = (dateString) => {
    if (!dateString) return 'N/A';
    const now = new Date();
    const date = new Date(dateString);
    const seconds = Math.floor((now - date) / 1000);

    // CORRECTION : Gère les temps négatifs (désynchronisation d'horloge) et très courts.
    if (seconds < 10) {
        return `à l'instant`;
    } else if (seconds < 60) {
        return `il y a ${seconds} sec`;
    }
    const minutes = Math.floor(seconds / 60);
    if (minutes < 60) {
        return `il y a ${minutes} min`;
    }
    const hours = Math.floor(minutes / 60);
    if (hours < 24) {
        return `il y a ${hours} h`;
    }
    const days = Math.floor(hours / 24);
    return `il y a ${days} j`;
};

/* ------------------------------------------------ */

        // --- Variables Globales et Configuration ---

        let selectedItem = null; // Aucun article sélectionné par défaut
        let isFetching = false; // Empêche les clics multiples pendant le chargement
        let showImages = true; // Afficher les images par défaut
        let chartInstance = null; // Instance de Chart.js pour l'historique

        // NOUVEAU: Variables pour le Scan d'Opportunités
        let opportunityResults = []; 
        let buyCityFilter = '';
        let sellCityFilter = '';
        let currentSort = { column: 'profit', direction: 'desc' }; // Tri par défaut
        
        // Villes principales d'Albion (Serveur Europe)
        const CITIES = ["Caerleon", "Thetford", "Fort Sterling", "Lymhurst", "Bridgewatch", "Martlock", "Brecilien", "Black Market"];
        const API_BASE_URL = "https://europe.albion-online-data.com/api/v2/stats/prices";
        const API_HISTORY_URL = "https://europe.albion-online-data.com/api/v2/stats/history";
        const QUALITY_MAP = {
            1: "Normale",
            2: "Bonne",
            3: "Exceptionnelle",
            4: "Formidable",
            5: "Chef-d'œuvre"
        };
        const MAX_OPPORTUNITIES = 1500;

        let TAX_RATE = 0.050; // Taux de taxe par défaut (5%)

        // Mappage pour un accès rapide aux détails de l'article
        const itemMap = new Map(itemsData.map(item => [item.id, item]));


        // --- Fonctions d'API et de Données ---

        /**
         * Formate un nombre en tant que monnaie (Silver)
         * CORRIGÉ : Affiche 0 Silver au lieu de N/A pour les prix nuls ou indéfinis.
         * @param {number} num - Le nombre à formater.
         * @returns {string}
         */
        function formatSilver(num) {
            const number = num === null || num === undefined || isNaN(num) ? 0 : num;
            // Pour le formatage français (espaces comme séparateur de milliers)
            const formatted = new Intl.NumberFormat('fr-FR', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(number);
            
            return formatted + ' Silver';
        }

        /**
         * Simule un délai avec backoff exponentiel pour les appels d'API.
         * @param {number} attempt - Le numéro de la tentative actuelle.
         */
        const exponentialBackoff = async (attempt) => {
            const delay = Math.pow(2, attempt) * 1000;
            await new Promise(resolve => setTimeout(resolve, delay));
        };

        /**
         * Effectue l'appel à l'API avec gestion des erreurs et backoff.
         * @param {string} url - L'URL de l'API à appeler.
         * @param {number} [retries=3] - Nombre maximum de tentatives de réessai.
         * @returns {Promise<any>}
         */
        async function fetchWithRetry(url, retries = 3) {
            for (let attempt = 1; attempt <= retries; attempt++) {
                try {
                    const response = await fetch(url);
                    if (!response.ok) {
                        throw new Error(`Erreur HTTP! Statut: ${response.status}`);
                    }
                    return await response.json();
                } catch (error) {
                    if (attempt < retries) {
                        // console.warn(`Tentative ${attempt} échouée pour ${url}. Réessai...`);
                        await exponentialBackoff(attempt);
                    } else {
                        throw new Error("Impossible de récupérer les données du marché après plusieurs tentatives.");
                    }
                }
            }
        }

        /**
         * Récupère les données d'historique pour l'article sélectionné.
         * @param {string} itemId - L'ID de l'article.
         * @param {string} location - La ville pour laquelle récupérer l'historique.
         * @returns {Promise<Array<Object>>}
         */
        async function fetchHistoryData(itemId, location) {
            const historyUrl = `${API_HISTORY_URL}/${itemId}?locations=${location}&time-scale=24&date=`;
            try {
                const data = await fetchWithRetry(historyUrl);
                // L'API retourne un tableau, nous prenons le premier élément (la ville demandée)
                return data[0]?.data || [];
            } catch (error) {
                console.error(`Erreur lors de la récupération de l'historique pour ${location}:`, error.message);
                return [];
            }
        }

        // --- Fonctions d'Actualisation et Notification ---

        /**
         * Affiche une notification temporaire de succès.
         * @param {string} message - Message à afficher.
         */
        function showNotification(message) {
            const notificationContainer = document.getElementById('notification-container');
            if (!notificationContainer) return; // S'assure que le conteneur existe
            
            const notification = document.createElement('div');
            notification.className = 'bg-green-600 text-white px-4 py-3 rounded-lg shadow-2xl flex items-center transform transition-all duration-300 ease-out translate-y-0 opacity-100';
            notification.innerHTML = `<i data-lucide="check-circle" class="w-5 h-5 mr-2"></i> ${message}`;
            
            notificationContainer.appendChild(notification);
            if (typeof lucide !== 'undefined') { lucide.createIcons(); }

            // Retirer la notification après 3 secondes
            setTimeout(() => {
                notification.classList.add('opacity-0', 'translate-y-full'); // Animation de disparition
                notification.addEventListener('transitionend', () => notification.remove());
            }, 3000);
        }

        /**
         * Fonction pour actualiser les prix. Appelée par le bouton.
         */
        function refreshPrices() {
            if (selectedItem) {
                // Le paramètre true indique que c'est un rafraîchissement manuel et doit afficher la notification.
                fetchAndDisplayPrices(true);
            } else {
                showNotification("Veuillez d'abord sélectionner un article.");
            }
        }
        
        /**
         * Fonction principale pour récupérer les prix et mettre à jour l'interface.
         * @param {boolean} [isManualRefresh=false] - Indique si l'appel vient d'un bouton manuel.
         */
        async function fetchAndDisplayPrices(isManualRefresh = false) {
            if (!selectedItem || isFetching) return;

            isFetching = true;
            
            // 1. Mettre à jour l'image et les détails de l'article immédiatement
            updateItemDetails(); 

            const priceContainer = document.getElementById('price-data');
            const historyContainer = document.getElementById('history-data');
            
            // 2. Afficher l'état de chargement
            priceContainer.innerHTML = getLoadingHtml('Chargement des prix actuels...');
            historyContainer.innerHTML = getLoadingHtml('Chargement de l\'historique des prix...');
            if (typeof lucide !== 'undefined') { lucide.createIcons(); }

            const currentPriceUrl = `${API_BASE_URL}/${selectedItem}?locations=${CITIES.join(',')}`;

            try {
                const currentData = await fetchWithRetry(currentPriceUrl);
                
                // Filtrer les données sans prix valides (tous les prix à 0)
                const validData = currentData.filter(item => item.sell_price_min > 0 || item.buy_price_max > 0);
                
                // 3. Rendu des nouvelles données de prix après la réception
                if (currentData.length === 0) { // Si aucune donnée n'est renvoyée (même invalide)
                    priceContainer.innerHTML = getErrorHtml('Aucune donnée de prix trouvée pour cet article dans les cités.');
                    historyContainer.innerHTML = getErrorHtml("Historique non disponible.");
                    return;
                }
                
                renderPriceData(currentData); // Utilisez currentData qui inclut les prix 0/N/A pour le tableau
                
                // 4. Lancer la récupération de l'historique (par défaut la meilleure ville de vente)
                if (validData.length > 0) {
                    const bestSale = validData.reduce((prev, current) => 
                        (current.sell_price_min > prev.sell_price_min) ? current : prev, 
                        { sell_price_min: -1 }
                    );

                    const cityForHistory = bestSale.city && bestSale.sell_price_min > 0 ? bestSale.city : validData[0].city;
                    const historyData = await fetchHistoryData(selectedItem, cityForHistory);
                    renderHistoryChart(historyData, cityForHistory);
                } else {
                    historyContainer.innerHTML = getErrorHtml("Historique non disponible car aucun prix valide (supérieur à 0) n'a été trouvé.");
                }
                
                // Notification de succès uniquement si l'actualisation est manuelle
                if (isManualRefresh) {
                    const itemName = itemMap.get(selectedItem)?.name_fr || selectedItem;
                    showNotification(`Prix de "${itemName}" actualisés avec succès !`);
                }

            } catch (error) {
                console.error("Erreur lors de la récupération des données:", error.message);
                priceContainer.innerHTML = getErrorHtml(error.message);
                historyContainer.innerHTML = getErrorHtml("Historique non disponible.");
            } finally {
                isFetching = false;
            }
        }


        // --- Fonctions d'Interface Utilisateur (UI) ---

        /**
         * Génère le HTML pour l'état de chargement.
         * @param {string} message - Message à afficher.
         */
        function getLoadingHtml(message) {
             return `
                <div class="text-center py-12">
                    <span class="animate-spin text-4xl text-blue-500" data-lucide="loader-circle"></span>
                    <p class="text-blue-400 mt-3 font-semibold">${message}</p>
                </div>
            `;
        }
        
        /**
         * Génère le HTML pour un message d'erreur.
         * @param {string} message - Message d'erreur.
         */
        function getErrorHtml(message) {
            return `
                <div class="text-center py-6 bg-red-900/30 rounded-xl border border-red-700 mx-4">
                    <span class="text-red-400 text-3xl" data-lucide="alert-triangle"></span>
                    <p class="text-red-400 font-semibold mt-2">Erreur de Données</p>
                    <p class="text-red-500 text-sm mt-1">${message}</p>
                </div>
            `;
        }

        /**
         * Met à jour l'affichage des détails de l'article sélectionné (image, nom, ID, catégorie).
         */
        function updateItemDetails() {
            const currentItem = itemMap.get(selectedItem);
            // Extrait le niveau d'enchantement (@1, @2, @3) s'il existe
            const qualityMatch = selectedItem.match(/LEVEL(\d+)/);
            let qualityText = 'Normal (.0)';

            if (qualityMatch) {
                const level = parseInt(qualityMatch[1]);
                const levelMap = { 1: '.1 (Inhabituel)', 2: '.2 (Rare)', 3: '.3 (Exceptionnel)' };
                qualityText = levelMap[level] || 'Normal';
            } else if (selectedItem.includes('LEVEL')) {
                // Pour les artéfacts ou autres ID non standard
                qualityText = 'Artéfact / Équipement Spécial';
            }
            
            // Mise à jour des textes
            document.getElementById('item-details-name').textContent = currentItem ? currentItem.name_fr : 'Article Inconnu';
            document.getElementById('item-details-category').textContent = currentItem ? currentItem.category : 'N/A';
            document.getElementById('item-details-quality').textContent = qualityText;
            document.getElementById('item-details-id').textContent = selectedItem;
            
            // Mise à jour de l'image
            const itemImage = document.getElementById('item-image');
            const itemImageContainer = document.getElementById('item-image-wrapper');

            if (showImages) {
                itemImageContainer.classList.remove('hidden');
                itemImage.src = `https://render.albiononline.com/v1/item/${selectedItem}.png?size=128`;
                itemImage.onerror = function() {
                    this.onerror = null;
                    this.src = 'https://placehold.co/128x128/3f3f46/3f3f46?text=Image+N/A';
                };
            } else {
                itemImageContainer.classList.add('hidden');
            }

            // Afficher le contenu des détails, masquer le message d'attente
            document.getElementById('item-details-wrapper').style.display = 'flex';
            document.getElementById('no-item-selected-message').style.display = 'none';

        }

        /**
         * Rend le graphique d'historique des prix.
         * CORRIGÉ : Formatage de l'heure pour ne pas avoir 00:00 partout.
         * @param {Array<Object>} historyData - Les données d'historique des prix.
         * @param {string} city - La ville pour laquelle récupérer l'historique.
         */
        function renderHistoryChart(historyData, city) {
            const historyContainer = document.getElementById('history-data');
            
            if (historyData.length === 0) {
                historyContainer.innerHTML = getErrorHtml(`Historique non disponible pour ${city} sur les dernières 24h.`);
                return;
            }

            // Trier les données par date
            historyData.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

            // CORRECTION: Utilisation de 'hour: "2-digit", minute: "2-digit"' pour s'assurer que l'heure n'est pas 00:00
            const labels = historyData.map(d => new Date(d.timestamp).toLocaleTimeString('fr-FR', {
                hour: '2-digit', 
                minute:'2-digit'
            }));
            const avgPrices = historyData.map(d => d.avg_price);

            historyContainer.innerHTML = `<canvas id="priceChart" class="p-2 bg-gray-800 rounded-xl"></canvas>`;

            const ctx = document.getElementById('priceChart').getContext('2d');

            if (chartInstance) {
                chartInstance.destroy(); // Détruire l'instance précédente
            }

            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: `Prix Moyen (24h) à ${city}`,
                        data: avgPrices,
                        borderColor: '#3b82f6', // blue-500
                        backgroundColor: 'rgba(59, 130, 246, 0.2)',
                        tension: 0.2,
                        fill: true,
                        pointRadius: 3,
                        pointHoverRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: false,
                            grid: { color: '#374151' }, // gray-700
                            ticks: { 
                                color: '#e4e4e7',
                                callback: (value) => formatSilver(value).split(' ')[0]
                            },
                            title: { display: true, text: 'Prix Moyen (Silver)', color: '#9ca3af' }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: '#e4e4e7' },
                            title: { display: true, text: 'Heure (dernières 24h)', color: '#9ca3af' }
                        }
                    },
                    plugins: {
                        legend: { labels: { color: '#e4e4e7' } },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return ` Prix : ${formatSilver(context.raw)}`;
                                }
                            }
                        }
                    }
                }
            });
            // Assurer que le conteneur du graphique a une hauteur définie pour le responsive
            document.getElementById('priceChart').parentElement.style.height = '400px'; 
        }

        /**
         * Rend le tableau des prix actuels et calcule les opportunités de revente.
         * CORRIGÉ : Gère le cas où buy/sell_price_min/max sont 0 pour l'affichage des stats.
         * @param {Array<Object>} data - Les données de prix actuels de l'API.
         */
        function renderPriceData(data) {
            const priceContainer = document.getElementById('price-data');
            
            if (!data || data.length === 0) {
                priceContainer.innerHTML = getErrorHtml('Aucune donnée de prix trouvée pour cet article.');
                return;
            }

            // Calculer la meilleure offre d'achat (max buy_price_max) et la meilleure offre de vente (min sell_price_min)
            let bestBuy = { price: 0, city: 'N/A', timestamp: 0 };
            let bestSell = { price: Infinity, city: 'N/A', timestamp: 0 };

            data.forEach(item => {
                // Pour l'achat (vous vendez), on prend le prix max
                if (item.buy_price_max > bestBuy.price) {
                    bestBuy = { price: item.buy_price_max, city: item.city, timestamp: item.buy_price_max_date };
                }
                // Pour la vente (vous achetez), on prend le prix min > 0
                if (item.sell_price_min > 0 && item.sell_price_min < bestSell.price) {
                    bestSell = { price: item.sell_price_min, city: item.city, timestamp: item.sell_price_min_date };
                }
            });
            
            // Si bestSell.price est toujours Infinity, cela signifie qu'il n'y a aucune offre de vente > 0.
            const buyPrice = bestSell.price !== Infinity ? bestSell.price : 0; // Prix d'achat (le plus bas listing)
            const sellPrice = bestBuy.price; // Prix de vente (le plus haut buy order)
            const buyCity = bestSell.price !== Infinity ? bestSell.city : 'N/A';
            const sellCity = bestBuy.city;

            
            // Prix pour la revente: Achat au prix Min Listing (BuyPrice) et Vente au prix Max Buy Order (SellPrice)
            const taxAmount = sellPrice * TAX_RATE;
            const netSellPrice = sellPrice - taxAmount;
            const potentialProfit = netSellPrice - buyPrice;
            
            // Déterminer la classe de couleur pour le profit
            let profitClass = 'bg-gray-800/50 border-gray-600';
            let profitIcon = 'trending-down';
            let profitColor = 'text-white';

            if (potentialProfit > 0) {
                profitClass = 'bg-green-800/50 border-green-600';
                profitIcon = 'trending-up';
                profitColor = 'text-green-300';
            } else if (potentialProfit < 0) {
                // CORRIGÉ : La classe est rouge pour un profit négatif
                profitClass = 'bg-red-800/50 border-red-600';
                profitIcon = 'trending-down';
                profitColor = 'text-red-300';
            }
            
            // Déterminer la classe de couleur pour le prix d'achat
            const buyPriceColor = buyPrice > 0 ? 'text-white' : 'text-red-400';
            // Déterminer la classe de couleur pour le prix de vente
            const sellPriceColor = sellPrice > 0 ? 'text-white' : 'text-red-400';


            // Rendu des stats principales
            const statsHtml = `
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <div class="p-3 bg-gray-700 rounded-lg shadow-md border border-gray-600">
                        <p class="text-sm text-yellow-400 font-semibold flex items-center"><i data-lucide="package-open" class="w-4 h-4 mr-1"></i> Acheter au Min</p>
                        <p class="text-xl font-bold ${buyPriceColor} mt-1">${formatSilver(buyPrice)}</p>
                        <p class="text-xs text-gray-400">${buyCity} (Offre de Vente Min)</p>
                    </div>
                    <div class="p-3 bg-gray-700 rounded-lg shadow-md border border-gray-600">
                        <p class="text-sm text-green-400 font-semibold flex items-center"><i data-lucide="wallet" class="w-4 h-4 mr-1"></i> Vendre au Max</p>
                        <p class="text-xl font-bold ${sellPriceColor} mt-1">${formatSilver(sellPrice)}</p>
                        <p class="text-xs text-gray-400">${sellCity} (Offre d'Achat Max)</p>
                    </div>
                    <div class="p-3 bg-gray-700 rounded-lg shadow-md border border-gray-600">
                        <p class="text-sm text-indigo-400 font-semibold flex items-center"><i data-lucide="percent" class="w-4 h-4 mr-1"></i> Taxe de Vente (${(TAX_RATE * 100).toFixed(1)}%)</p>
                        <p class="text-xl font-bold text-white mt-1">${formatSilver(taxAmount)}</p>
                        <p class="text-xs text-gray-400">Coût de la revente dans ${sellCity}</p>
                    </div>
                    <div class="p-3 rounded-lg shadow-md border ${profitClass}">
                        <p class="text-sm ${profitColor} font-semibold flex items-center"><i data-lucide="${profitIcon}" class="w-4 h-4 mr-1"></i> Profit Potentiel (Net)</p>
                        <p class="text-xl font-bold ${profitColor} mt-1">${formatSilver(potentialProfit)}</p>
                        <p class="text-xs text-gray-200">Profit Inter-Cité</p>
                    </div>
                </div>
            `;

            // Rendu du tableau détaillé
            const tableHtml = `
                <div class="bg-gray-800/80 p-4 rounded-xl shadow-lg overflow-x-auto">
                    <h3 class="text-lg font-bold text-white mb-3">Détails des Offres par Ville</h3>
                    <table class="min-w-full divide-y divide-gray-700">
                        <thead class="bg-gray-700/50">
                            <tr>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-400 uppercase">Ville</th>
                                <th class="px-3 py-2 text-right text-xs font-medium text-gray-400 uppercase">Achat Max (Vous Vendez)</th>
                                <th class="px-3 py-2 text-right text-xs font-medium text-gray-400 uppercase">Vente Min (Vous Achetez)</th>
                                <th class="px-3 py-2 text-right text-xs font-medium text-gray-400 uppercase">Dernière Mise à Jour</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-700">
                            ${CITIES.map(city => {
                                // Important : Utiliser data et non validData pour inclure les prix à 0 dans le tableau
                                const item = data.find(d => d.city === city) || {};
                                const sellPriceCity = item.buy_price_max; // Max Buy Order (ce que vous vendez)
                                const buyPriceCity = item.sell_price_min; // Min Listing Price (ce que vous achetez)
                                
                                const isBestBuy = buyPriceCity === buyPrice && city === buyCity && buyPrice > 0;
                                const isBestSell = sellPriceCity === sellPrice && city === sellCity && sellPrice > 0;
                                const isBestRow = isBestBuy || isBestSell;
                                
                                return `
                                    <tr class="hover:bg-gray-700/50 transition duration-100 ${isBestRow ? 'font-bold bg-blue-900/30' : ''}">
                                        <td class="px-3 py-2 whitespace-nowrap text-sm text-white">${city}</td>
                                        <td class="px-3 py-2 whitespace-nowrap text-sm ${isBestSell ? 'text-green-300' : 'text-gray-300'} text-right">
                                            ${formatSilver(sellPriceCity)}
                                        </td>
                                        <td class="px-3 py-2 whitespace-nowrap text-sm ${isBestBuy ? 'text-yellow-300' : 'text-gray-300'} text-right">
                                            ${formatSilver(buyPriceCity)}
                                        </td>
                                        <td class="px-3 py-2 whitespace-nowrap text-xs text-gray-400 text-right">
                                            ${item.sell_price_min_date ? new Date(item.sell_price_min_date).toLocaleDateString('fr-FR', {
                                                day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit'
                                            }) : 'Inconnu'}
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            priceContainer.innerHTML = statsHtml + tableHtml;
            // Réinitialiser les icônes lucide après l'injection de nouveau HTML
            if (typeof lucide !== 'undefined') { lucide.createIcons(); }
        }

        /**
         * Gère le clic sur un article de la liste. C'est le point clé pour la mise à jour dynamique.
         * @param {string} itemId - L'ID de l'article.
         */
        function selectItem(itemId) {
            // 1. Mettre à jour la variable globale
            selectedItem = itemId;
            
            // 2. Mettre à jour immédiatement l'apparence de la liste pour montrer la sélection (fond bleu)
            filterItems(); 
            
            // 3. Déclencher la récupération des nouveaux prix et la mise à jour des détails/stats
            fetchAndDisplayPrices();
        }

        /**
         * Filtre les articles en fonction de la saisie de l'utilisateur.
         * Est également utilisé pour rafraîchir la liste après une sélection.
         */
        function filterItems() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const filteredItems = itemsData.filter(item => 
                item.name_fr.toLowerCase().includes(searchTerm) || 
                item.id.toLowerCase().includes(searchTerm) ||
                item.category.toLowerCase().includes(searchTerm)
            );
            
            renderItemList(filteredItems);
        }

        /**
         * Rend la liste des articles cliquables.
         * @param {Array<Object>} data - Liste des articles filtrés.
         */
        function renderItemList(data) {
            const listContainer = document.getElementById('item-list');
            
            if (data.length === 0) {
                listContainer.innerHTML = '<p class="text-gray-400 p-4 text-center">Aucun article trouvé.</p>';
                return;
            }

            listContainer.innerHTML = data.map(item => {
                const imageUrl = showImages 
                    ? `https://render.albiononline.com/v1/item/${item.id}.png?size=40` 
                    : 'https://placehold.co/40x40/3f3f46/3f3f46?text=?';
                
                // Classe de sélection pour l'article actuellement sélectionné
                const selectedClass = (item.id === selectedItem) 
                    ? 'bg-blue-700/50 border-blue-500' 
                    : 'bg-gray-700 hover:bg-gray-600 border-gray-600';

                return `
                    <div class="p-2 rounded-lg cursor-pointer flex items-center transition duration-150 border shadow-lg ${selectedClass}" onclick="selectItem('${item.id}')">
                        <img src="${imageUrl}" class="w-10 h-10 min-w-10 rounded mr-2 bg-gray-600 object-contain ${showImages ? '' : 'hidden'}" alt="${item.name_fr}" 
                            onerror="this.onerror=null;this.src='https://placehold.co/40x40/3f3f46/3f3f46';" loading="lazy">
                        <div>
                            <p class="text-sm font-semibold text-white">${item.name_fr}</p>
                            <p class="text-xs text-blue-400 truncate" title="${item.id}">${item.id}</p>
                            <p class="text-xs text-gray-400">${item.category}</p>
                        </div>
                    </div>
                `;
            }).join('');
            if (typeof lucide !== 'undefined') { lucide.createIcons(); }
        }
        
        // Gère l'activation/désactivation des images
        function toggleImages(checkbox) {
            showImages = checkbox.checked;
            filterItems(); // Rafraîchit la liste pour appliquer le changement
        }
        

        // NOUVEAU: Fonction pour filtrer et trier les opportunités
        function sortAndRenderOpportunities(column, direction) {
            // Mise à jour de l'état de tri
            currentSort = { column, direction };

            let filteredResults = opportunityResults.filter(op => {
                const buyMatch = !buyCityFilter || op.buyCity === buyCityFilter;
                const sellMatch = !sellCityFilter || op.sellCity === sellCityFilter;
                const isProfitableAndPriced = op.profit > 0 && op.buyPrice > 0; 
                return buyMatch && sellMatch && isProfitableAndPriced;
             });

            // Logique de tri
            filteredResults.sort((a, b) => {
                let valA, valB;
                switch(column) {
                    case 'buyPrice':
                        valA = a.buyPrice;
                        valB = b.buyPrice;
                        break;
                    case 'sellPriceGross':
                        valA = a.sellPriceGross;
                        valB = b.sellPriceGross;
                        break;
                    case 'profit':
                    default:
                        valA = a.profit;
                        valB = b.profit;
                        break;
                    case 'sellPriceGross':
                        valA = a.sellPriceGross;
                        valB = b.sellPriceGross;
                        break;
                        // NOUVEAU: Tri par Date Récence (sellDate)
                        case 'recent':
                        valA = new Date(a.sellDate).getTime();
                        valB = new Date(b.sellDate).getTime();
                        break;
                        case 'profit':
                }

                if (valA < valB) return direction === 'asc' ? -1 : 1;
                if (valA > valB) return direction === 'asc' ? 1 : -1;
                return 0;
            });

            // Limiter le nombre de résultats
            if (filteredResults.length > MAX_OPPORTUNITIES) {
                filteredResults = filteredResults.slice(0, MAX_OPPORTUNITIES);
            }

            const opportunityContent = document.getElementById('opportunityContent');

            if (opportunityResults.length === 0) {
                opportunityContent.innerHTML = getErrorHtml('Aucune opportunité de trading inter-cité (profit > 0) n\'a été trouvée avec le taux de taxe actuel.');
                if (typeof lucide !== 'undefined') { lucide.createIcons(); }
                return;
            }

            // NOUVEAU: Message spécifique si les filtres ne retournent aucun résultat
            if (filteredResults.length === 0 && (buyCityFilter || sellCityFilter)) { 
                opportunityContent.innerHTML = `
                    <div class="text-center py-12 bg-gray-800/50 rounded-xl border border-gray-700">
                        <span class="text-yellow-400 text-3xl" data-lucide="filter-x"></span>
                        <p class="text-yellow-300 font-semibold mt-2">Aucun résultat</p>
                        <p class="text-gray-400 text-sm mt-1">Aucune opportunité ne correspond à vos filtres de ville.</p>
                        <button onclick="resetCityFilters()" class="mt-4 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">Réinitialiser les filtres</button>
                    </div>
                `;
                if (typeof lucide !== 'undefined') { lucide.createIcons(); }
                return;
            }


            // Fonctions d'aide pour le tri
            const getSortIcon = (col) => {
                if (currentSort.column === col) {
                    return currentSort.direction === 'asc' 
                        ? `<i data-lucide="arrow-up" class="w-4 h-4 ml-1"></i>` 
                        : `<i data-lucide="arrow-down" class="w-4 h-4 ml-1"></i>`;
                }
                return `<i data-lucide="arrow-up-down" class="w-4 h-4 ml-1 opacity-50"></i>`;
            };

            const getNewSortDirection = (col) => {
                // Inverse la direction si la même colonne est cliquée à nouveau
                if (currentSort.column === col) {
                    return currentSort.direction === 'desc' ? 'asc' : 'desc';
                }
                // Tri par défaut descendant pour le profit
                return (col === 'profit' || col === 'recent' || col === 'sellPriceGross') ? 'desc' : 'asc';
            };

            // UI des filtres
            const cityOptions = CITIES.map(city => `<option value="${city}">${city}</option>`).join('');

            const filterHtml = `
                <div class="p-4 bg-gray-800/80 rounded-xl shadow-lg mb-6 flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4">
                    <div class="flex-1">
                        <label class="block text-sm font-medium text-gray-400 mb-1">Acheter dans la ville:</label>
                        <select id="buyCityFilter" onchange="updateCityFilters(this.value, 'buy')" 
                                class="w-full p-2 border border-gray-600 bg-gray-900 text-white rounded-lg focus:ring-blue-500 focus:border-blue-500">
                            <option value="">-- Toutes les Villes --</option>
                            ${cityOptions}
                        </select>
                    </div>
                    <div class="flex-1">
                        <label class="block text-sm font-medium text-gray-400 mb-1">Vendre dans la ville:</label>
                        <select id="sellCityFilter" onchange="updateCityFilters(this.value, 'sell')" 
                                class="w-full p-2 border border-gray-600 bg-gray-900 text-white rounded-lg focus:ring-blue-500 focus:border-blue-500">
                            <option value="">-- Toutes les Villes --</option>
                            ${cityOptions}
                        </select>
                    </div>
                </div>
            `;

            // Rendu du tableau des résultats
            const tableHtml = `
                <div class="bg-gray-800/80 p-4 rounded-xl shadow-lg overflow-x-auto">
                    <h3 class="text-xl font-bold text-white mb-3">Opportunités de Trading (Taxe: ${(TAX_RATE * 100).toFixed(1)}%)</h3>
                    <table class="min-w-full divide-y divide-gray-700">
                        <thead class="bg-gray-700/50">
                            <tr>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-400 uppercase">Article</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-400 uppercase">Qualité</th>
                                
                                <th class="px-3 py-2 text-right text-xs font-medium text-gray-400 uppercase cursor-pointer" onclick="sortAndRenderOpportunities('buyPrice', '${getNewSortDirection('buyPrice')}')">
                                    <span class="flex items-center justify-end">Prix Achat (Min Listing)${getSortIcon('buyPrice')}</span>
                                </th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-400 uppercase">Acheter à</th>
                                
                                <th class="px-3 py-2 text-right text-xs font-medium text-gray-400 uppercase cursor-pointer" onclick="sortAndRenderOpportunities('sellPriceGross', '${getNewSortDirection('sellPriceGross')}')">
                                    <span class="flex items-center justify-end">Prix Vente (Max Buy Order)${getSortIcon('sellPriceGross')}</span>
                                </th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-400 uppercase">Vendre à</th>
                                
                                <th class="px-3 py-2 text-right text-xs font-medium text-white uppercase bg-blue-700/30 cursor-pointer" onclick="sortAndRenderOpportunities('profit', '${getNewSortDirection('profit')}')">
                                    <span class="flex items-center justify-end">Profit Net (Silver)${getSortIcon('profit')}</span>
                                </th>
                                <th class="px-3 py-2 text-right text-xs font-medium text-gray-400 uppercase">Marge (%)</th>
                                <th class="px-3 py-2 text-right text-xs font-medium text-gray-400 uppercase cursor-pointer" onclick="sortAndRenderOpportunities('recent', '${getNewSortDirection('recent')}')">
                                    <span class="flex items-center justify-end">MàJ Vente${getSortIcon('recent')}</span>
                                </th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-700">
                            ${filteredResults.map(op => `
                                <tr class="hover:bg-gray-700/50 transition duration-100">
                                    <td class="px-3 py-2 whitespace-nowrap text-sm text-white flex items-center">
                                        <img src="https://render.albiononline.com/v1/item/${op.itemId}.png?quality=${op.quality}" 
                                             class="w-10 h-10 mr-3 rounded bg-gray-900" 
                                             alt="${op.itemName}"
                                             onerror="this.onerror=null;this.src='https://placehold.co/40x40/3f3f46/3f3f46';">
                                        ${op.itemName}
                                    </td>
                                    
                                    <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-300">${QUALITY_MAP[op.quality] || op.quality}</td>
                                    
                                    <td class="px-3 py-2 whitespace-nowrap text-sm text-yellow-300 text-right">${formatSilver(op.buyPrice)}</td>
                                    <td class="px-3 py-2 whitespace-nowrap text-xs text-gray-400">${op.buyCity}</td>
                                    
                                    <td class="px-3 py-2 whitespace-nowrap text-sm text-green-300 text-right">${formatSilver(op.sellPriceGross)}</td>
                                    <td class="px-3 py-2 whitespace-nowrap text-xs text-gray-400">${op.sellCity}</td>

                                    <td class="px-3 py-2 whitespace-nowrap text-sm font-bold ${op.profit > 0 ? 'text-green-400' : 'text-red-400'} text-right bg-blue-900/10">
                                        ${formatSilver(op.profit)}
                                    </td>
                                    <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-300 text-right">
                                        ${op.profitMargin.toFixed(1)}%
                                    </td>
                                    <td class="px-3 py-2 whitespace-nowrap text-xs text-gray-500 text-right" title="${new Date(op.sellDate).toLocaleString('fr-FR')}">
                                        ${getTimeAgo(op.sellDate)}
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;

            opportunityContent.innerHTML = filterHtml + tableHtml;
            // Mise à jour de la sélection des filtres après injection
            document.getElementById('buyCityFilter').value = buyCityFilter;
            document.getElementById('sellCityFilter').value = sellCityFilter;

            if (typeof lucide !== 'undefined') { lucide.createIcons(); }
        }

        // NOUVEAU: Fonction de mise à jour des filtres et de re-rendu
        function updateCityFilters(city, type) {
            if (type === 'buy') {
                buyCityFilter = city;
            } else if (type === 'sell') {
                sellCityFilter = city;
            }
            // Re-trier et re-filtrer les résultats existants
            sortAndRenderOpportunities(currentSort.column, currentSort.direction);
        }

        // NOUVEAU: Fonction pour réinitialiser les filtres et réafficher les résultats
        function resetCityFilters() {
            buyCityFilter = '';
            sellCityFilter = '';
            sortAndRenderOpportunities(currentSort.column, currentSort.direction);
        }

        // NOUVEAU: Fonction de scan principal des opportunités
        async function scanOpportunities() {
            if (isFetching) return;

            const opportunityContent = document.getElementById('opportunityContent');
            opportunityContent.innerHTML = getLoadingHtml('Analyse des prix pour tous les articles. Ceci peut prendre quelques secondes...');
            if (typeof lucide !== 'undefined') { lucide.createIcons(); }

            try {
                isFetching = true;
                opportunityResults = [];

                const cityString = CITIES.join(',');

                // CORRECTION: Diviser les items en plusieurs groupes pour éviter une URL trop longue
                const CHUNK_SIZE = 200; // Nombre d'items par appel API
                let allPrices = [];
                for (let i = 0; i < itemsData.length; i += CHUNK_SIZE) {
                    const chunk = itemsData.slice(i, i + CHUNK_SIZE);
                    const itemIdsChunk = chunk.map(item => item.id).join(',');
                    const url = `${API_BASE_URL}/${itemIdsChunk}?locations=${cityString}`;
                    try {
                        const prices = await fetchWithRetry(url);
                        if (prices && Array.isArray(prices)) {
                            allPrices.push(...prices);
                        }
                    } catch (chunkError) {
                        console.warn(`Échec du chargement pour un groupe d'items: ${chunkError.message}`);
                    }
                }

                if (allPrices.length === 0) {
                    throw new Error("L'API n'a retourné aucune donnée valide.");
                }

                // Créer une map pour un accès rapide aux prix par item
                const priceMap = new Map();
                for (const priceData of allPrices) {
                    if (!priceMap.has(priceData.item_id)) {
                        priceMap.set(priceData.item_id, []);
                    }
                    priceMap.get(priceData.item_id).push(priceData);
                }

                // Analyser toutes les combinaisons pour trouver des opportunités
                for (const [itemId, prices] of priceMap.entries()) {
                    const itemData = itemMap.get(itemId);
                    if (!itemData) continue;

                    for (const buyItem of prices) {
                        const buyPrice = buyItem.sell_price_min;
                        if (buyPrice <= 0) continue;

                        for (const sellItem of prices) {
                            const sellPriceGross = sellItem.buy_price_max;
                            if (sellPriceGross > 0 && buyItem.city !== sellItem.city) {
                                const taxAmount = sellPriceGross * TAX_RATE;
                                const sellPriceNet = sellPriceGross - taxAmount;
                                const profit = sellPriceNet - buyPrice;

                                if (profit > 0) {
                                    opportunityResults.push({
                                        itemId,
                                        itemName: itemData.name_fr,
                                        quality: buyItem.quality,
                                        buyCity: buyItem.city,
                                        buyPrice,
                                        sellCity: sellItem.city,
                                        sellPriceGross,
                                        taxAmount,
                                        sellPriceNet,
                                        profit,
                                        profitMargin: (profit / buyPrice) * 100,
                                        sellDate: sellItem.buy_price_max_date
                                    });
                                }
                            }
                        }
                    }
                }
                
                // Après le scan, on trie et on affiche les résultats
                sortAndRenderOpportunities(currentSort.column, currentSort.direction); 
            } catch (error) {
                console.error("Erreur lors du scan d'opportunités:", error);
                opportunityContent.innerHTML = getErrorHtml(error.message || "Une erreur inconnue est survenue.");
            } finally {
                isFetching = false;
            }
        }

        // Gère la navigation dans les vues
        function changeView(viewId) {
            // Masquer toutes les vues
            document.getElementById('detailView').style.display = 'none';
            document.getElementById('opportunityView').style.display = 'none';
            document.getElementById('settingsView').style.display = 'none';

            // Afficher la vue sélectionnée
            document.getElementById(viewId).style.display = 'block';

            // Mettre à jour l'état des onglets
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('bg-blue-700', 'text-white', 'shadow-lg');
                tab.classList.add('text-gray-400', 'hover:bg-gray-700');
            });
            document.getElementById(`${viewId}Tab`).classList.add('bg-blue-700', 'text-white', 'shadow-lg');
            document.getElementById(`${viewId}Tab`).classList.remove('text-gray-400', 'hover:bg-gray-700');

            // Logique spécifique à la vue
            if (viewId === 'detailView') {
                // S'assurer que les détails de l'article sont mis à jour au retour
                if(selectedItem) {
                    // Force un rafraîchissement des données si c'est la première sélection
                    fetchAndDisplayPrices();
                }
            } else if (viewId === 'settingsView') {
                renderSettings();
            } else if (viewId === 'opportunityView') {
                // NOUVEAU: Logique pour l'onglet opportunité
                if (opportunityResults.length === 0) {
                    scanOpportunities();
                } else {
                    sortAndRenderOpportunities(currentSort.column, currentSort.direction);
                }
            }
        }

// =================================================================
// --- NOUVEAU: GESTION DE L'ACTUALISATION AUTOMATIQUE (5 minutes) ---
// =================================================================

const REFRESH_INTERVAL_MS = 5 * 60 * 1000;

// Démarrer l'actualisation automatique toutes les 5 minutes
setInterval(() => {
    // Log pour le développeur dans la console
    console.log("Actualisation automatique des prix...");
    
    // Appeler la fonction de rafraîchissement SEULEMENT si un article est sélectionné
    if (selectedItem) {
        fetchAndDisplayPrices(false); 
    }
}, REFRESH_INTERVAL_MS);

console.log(`Actualisation automatique démarrée : toutes les ${REFRESH_INTERVAL_MS / 1000 / 60} minutes.`);

// N'oubliez pas la ligne ci-dessous si elle n'est pas déjà dans votre code d'initialisation :
// Activer les icônes Lucide pour tout le contenu chargé dynamiquement
if (typeof lucide !== 'undefined') {
    lucide.createIcons();
}

        function renderSettings() {
            const settingsContent = document.getElementById('settingsContent');
            settingsContent.innerHTML = `
                <div class="bg-gray-800/80 p-6 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold text-white mb-4">Paramètres de l'Outil</h2>
                    
                    <div class="space-y-4">
                        <div class="flex items-center justify-between p-4 bg-gray-700/50 rounded-lg border border-gray-700">
                            <div>
                                <p class="font-semibold text-lg text-white">Afficher les Images d'Articles</p>
                                <p class="text-sm text-gray-400">Désactiver pour une liste plus rapide ou si la connexion est lente.</p>
                            </div>
                            <label class="modern-toggle-switch">
                                <input type="checkbox" id="imageToggle" onchange="toggleImages(this)" ${showImages ? 'checked' : ''} />
                                <span class="modern-toggle-slider"></span>
                            </label>
                        </div>

                        <div class="flex items-center justify-between p-4 bg-gray-700/50 rounded-lg border border-gray-700">
                            <div>
                                <p class="font-semibold text-lg text-white">Statut Premium</p>
                                <p class="text-sm text-gray-400">Désactivé: 5% de taxe. Activé: 2.5% de taxe.</p>
                            </div>
                            <label class="modern-toggle-switch">
                                <input type="checkbox" id="taxToggle" onchange="updateTaxRate(this.checked)" ${TAX_RATE === 0.025 ? 'checked' : ''} />
                                <span class="modern-toggle-slider"></span>
                            </label>
                        </div>

                        <div class="p-3 bg-gray-700 rounded-lg">
                            <p class="font-semibold text-lg text-white">Serveur de Données Actuel</p>
                            <p class="text-sm text-yellow-400 mt-1">Europe (albion-online-data.com/api/v2/stats)</p>
                            <p class="text-xs text-gray-500 mt-2">Ce paramètre est fixe pour cette version du marché Européen.</p>
                        </div>
                    </div>
                </div>
            `;
        }

        function updateTaxRate(isPremium) {
            TAX_RATE = isPremium ? 0.025 : 0.050;
            
            // Réinitialiser les résultats pour forcer un nouveau calcul avec la nouvelle taxe
            opportunityResults = []; 
            
            if (document.getElementById('opportunityView').style.display !== 'none') {
                scanOpportunities();
            } else if (selectedItem) {
                fetchAndDisplayPrices();
            }
        }

        // Exécution initiale
        window.onload = () => {
             if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
            // Initialisation des états
            const imageToggle = document.getElementById('imageToggle');
            if (imageToggle) {
                showImages = imageToggle.checked; 
            }
            
            filterItems(); // Afficher la liste initiale
            changeView('detailView'); // Afficher la vue principale
            
            // Lancer la première recherche si un article par défaut est défini
            if (selectedItem) {
                fetchAndDisplayPrices();
            } else {
                // Assurer que le message initial est bien affiché
                document.getElementById('no-item-selected-message').style.display = 'block';
                document.getElementById('item-details-wrapper').style.display = 'none';
            }
        }

        
    </script>

    <main class="w-full px-4 sm:px-6 lg:px-8 py-8">
        
    <header class="mb-6">
        <h1 class="text-3xl font-extrabold text-blue-400">Albion EU Market Scanner <span class="text-xl text-gray-500">| Trading Inter-Cités</span></h1>
        <p class="text-gray-400">Source : Albion Data Project (Serveur Europe). Prix mis à jour en temps réel.</p>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        
        <div class="col-span-1 bg-gray-900 p-4 rounded-xl shadow-2xl border border-gray-700 h-full overflow-hidden flex flex-col">
            
            <div class="mb-4">
                <div class="relative">
                    <input type="text" id="search-input" oninput="filterItems()" placeholder="Rechercher un article..." 
                           class="w-full p-3 pl-10 bg-gray-800 text-white rounded-xl border border-gray-600 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition">
                    <i data-lucide="search" class="w-5 h-5 text-gray-400 absolute left-3 top-1/2 transform -translate-y-1/2"></i>
                </div>
            </div>

            <div id="item-list" class="space-y-3 overflow-y-auto flex-grow pr-2">
                </div>
            
        </div>

        <div class="lg:col-span-2"> 
            <div class="sticky top-16 z-10 flex bg-gray-900 p-1 rounded-xl border border-gray-700 shadow-xl mb-6">
                <button id="detailViewTab" onclick="changeView('detailView')" 
                        class="nav-tab flex-1 py-3 px-4 rounded-lg transition duration-150 flex items-center justify-center text-sm font-semibold">
                    <i data-lucide="bar-chart-3" class="w-4 h-4 mr-2"></i> Analyse Détaillée
                </button>
                <button id="opportunityViewTab" onclick="changeView('opportunityView')" 
                        class="nav-tab flex-1 py-3 px-4 rounded-lg transition duration-150 flex items-center justify-center text-sm font-semibold text-gray-400 hover:bg-gray-700">
                    <i data-lucide="rocket" class="w-4 h-4 mr-2"></i> Opportunités (Scan)
                </button>
                <button id="settingsViewTab" onclick="changeView('settingsView')" 
                        class="nav-tab flex-1 py-3 px-4 rounded-lg transition duration-150 flex items-center justify-center text-sm font-semibold text-gray-400 hover:bg-gray-700">
                    <i data-lucide="settings" class="w-4 h-4 mr-2"></i> Paramètres
                </button>
            </div>

            <div class="bg-gray-900 p-6 rounded-xl shadow-2xl border border-gray-700 min-h-[600px]">
                
                <div id="detailView" style="display: none;">
                    
                    <div id="item-details-wrapper" class="flex items-start mb-6 p-4 bg-gray-800/80 rounded-xl shadow-inner border border-gray-700" style="display: none;">
                        <div id="item-image-wrapper" class="flex-shrink-0 mr-4">
                            <img id="item-image" src="" 
                                 class="w-32 h-32 object-contain rounded-lg bg-gray-900" alt="Image de l'article">
                        </div>
                        <div class="flex-grow">
                            <div class="flex items-center justify-between">
                                <h2 id="item-details-name" class="text-2xl font-bold text-blue-300"></h2>
                                <button onclick="refreshPrices()" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 flex items-center shadow-lg transform active:scale-95">
                                    <i data-lucide="rotate-cw" class="w-4 h-4 mr-2"></i> Actualiser les prix
                                </button>
                            </div>
                            
                            <p class="text-sm text-gray-400 mt-2"><span class="font-semibold">ID:</span> <span id="item-details-id" class="text-yellow-400"></span></p>
                            <p class="text-sm text-gray-400"><span class="font-semibold">Qualité/Enchantement:</span> <span id="item-details-quality"></span></p>
                            <p class="text-sm text-gray-400"><span class="font-semibold">Catégorie:</span> <span id="item-details-category"></span></p>
                        </div>
                    </div>

                    <div id="price-and-history-content" class="space-y-6">
                        <div id="price-data" class="min-h-40">
                            </div>
                        <h3 class="text-xl font-bold text-white mb-2 pt-2 border-t border-gray-700">Historique des Prix (24h)</h3>
                        <div id="history-data" class="min-h-96">
                            </div>
                    </div>
                    
                    <div id="no-item-selected-message" class="p-8 text-center text-gray-500 bg-gray-800 rounded-xl" style="display: block;">
                        <i data-lucide="mouse-pointer-2" class="w-10 h-10 mx-auto mb-2"></i>
                        <p class="font-semibold">Veuillez sélectionner un article pour lancer l'analyse de marché.</p>
                    </div>

                </div>

                <div id="opportunityView" style="display: none;">
                    <div id="opportunityContent">
                        </div>
                </div>

                <div id="settingsView" style="display: none;">
                    <div id="settingsContent">
                        </div>
                </div>
                
            </div>
        </div>
    </div>
    </main>
    
    <div id="notification-container" class="fixed bottom-4 right-4 z-50 space-y-3">
        </div>

<meta property="og:title" content="Tools Albion" />
<meta property="og:description" content="Un outils fait pour Albion a l'aide de différente API utilisable par n'importe qui ." />
<meta property="og:type" content="website" />

</body>
</html>
